<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asset Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="/assets/styles.css"/>
</head>
<body>
  <div id="app">
    <!-- Bootstrap Warning -->
    <div id="bootstrap-warning" class="bootstrap-warning hidden">
      <div class="bootstrap-content">
        <h2>⚠️ System Not Initialized</h2>
        <p>The Asset Tracker database has not been set up yet.</p>
        <p>Please run the bootstrap script to initialize the system:</p>
        <pre><code>./bootstrap.sh</code></pre>
        <p>After running bootstrap, refresh this page.</p>
        <button onclick="location.reload()">Refresh Page</button>
      </div>
    </div>

    <!-- Header -->
    <header>
      <nav>
        <ul>
          <li><strong>Asset Tracker</strong></li>
        </ul>
        <ul>
          <li id="user-info"></li>
        </ul>
      </nav>
    </header>

    <!-- Login Panel -->
    <section id="login-panel" class="hidden">
      <article style="max-width: 400px; margin: 50px auto;">
        <h2>Sign in</h2>
        <form>
          <input id="username" placeholder="Username" required>
          <input id="password" type="password" placeholder="Password" required>
          <button id="login-btn">Login</button>
          <div id="login-msg"></div>
        </form>
      </article>
    </section>

    <!-- Main Content -->
    <section id="main" class="hidden">
      <!-- Toolbar -->
      <nav style="background: var(--form-element-background-color);">
        <ul>
          <li>
            <input id="search" placeholder="Search assets..." style="min-width: 300px;">
          </li>
          <li>
            <select id="owner-filter" style="min-width: 200px;">
              <option value="">All Owners</option>
            </select>
          </li>
        </ul>
        <ul>
          <li><button id="refresh">Refresh</button></li>
          <li><button id="new-asset">+ New Asset</button></li>
          <li>
            <button id="start-polling">▶ Start Polling</button>
            <button id="stop-polling">⏸ Stop Polling</button>
          </li>
          <li><button id="settings-btn">⚙ Settings</button></li>
        </ul>
      </nav>

      <!-- Asset Table -->
      <div style="overflow-x: auto;">
        <table id="asset-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>IP Addresses</th>
              <th>MAC Address</th>
              <th>Owner</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="asset-list"></tbody>
        </table>
      </div>

      <!-- Asset Detail Drawer -->
      <div id="drawer" class="drawer hidden">
        <div class="drawer-content">
          <button class="close">&times;</button>
          <div id="asset-detail"></div>
        </div>
      </div>

      <!-- Asset Modal -->
      <dialog id="asset-modal">
        <article>
          <header>
            <h3 id="modal-title">Add Asset</h3>
            <button aria-label="Close" class="modal-close"></button>
          </header>
          <form id="asset-form">
            <input type="hidden" id="asset-id">
            
            <label>Asset Name
              <input type="text" id="asset-name" placeholder="Asset Name" required>
            </label>
            
            <label>Type
              <select id="asset-type">
                <option value="">Select Type...</option>
                <option value="workstation">Workstation</option>
                <option value="server">Server</option>
                <option value="iot">IoT Device</option>
                <option value="network">Network Equipment</option>
                <option value="mobile">Mobile Device</option>
                <option value="unknown">Unknown</option>
              </select>
            </label>
            
            <label>MAC Address
              <input type="text" id="asset-mac" placeholder="00:11:22:33:44:55">
            </label>
            
            <label>IP Addresses (comma-separated)
              <input type="text" id="asset-ips" placeholder="192.168.1.10, 10.0.0.5">
            </label>
            
            <label>Asset Owner
              <select id="asset-owner">
                <option value="">No Owner</option>
              </select>
              <small>Assign this asset to a user</small>
            </label>
            
            <details>
              <summary>Attributes (JSON)</summary>
              <textarea id="asset-attributes" rows="4" placeholder='{"key": "value"}'></textarea>
            </details>
            
            <hr>
            <h4>Polling Configuration</h4>
            
            <label>
              <input type="checkbox" id="asset-poll-enabled">
              Enable Polling
            </label>
            
            <label>Poll Type
              <select id="asset-poll-type">
                <option value="ping">Ping (Online Check Only)</option>
                <option value="ssh">SSH (Linux/Unix)</option>
                <option value="wmi">WMI (Windows)</option>
                <option value="snmp">SNMP</option>
              </select>
            </label>
            
            <label>Poll Username (for SSH/WMI)
              <input type="text" id="asset-poll-username" placeholder="admin">
            </label>
            
            <label>Poll Password (for SSH/WMI)
              <input type="password" id="asset-poll-password" placeholder="Password">
            </label>
            
            <label>Poll Port (optional)
              <input type="number" id="asset-poll-port" placeholder="22 for SSH, 5985 for WMI">
            </label>
            
            <hr>
            
            <div style="display: flex; gap: 10px;">
              <button type="submit">Save Asset</button>
              <button type="button" class="secondary modal-cancel">Cancel</button>
            </div>
          </form>
        </article>
      </dialog>

      <!-- Delete Modal -->
      <dialog id="delete-modal">
        <article>
          <header>
            <h3>Delete Asset</h3>
          </header>
          <p>Are you sure you want to delete this asset?</p>
          <p><strong id="delete-asset-name"></strong></p>
          <p>This action cannot be undone.</p>
          <div style="display: flex; gap: 10px;">
            <button id="confirm-delete" class="contrast">Delete</button>
            <button type="button" class="secondary modal-cancel">Cancel</button>
          </div>
        </article>
      </dialog>

      <!-- Polling Status -->
      <footer style="margin-top: 20px;">
        <span id="polling-status" style="color: var(--muted-color);">Polling: Unknown</span>
      </footer>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="hidden">
      <div style="max-width: 900px; margin: 20px auto;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
          <h2>System Settings</h2>
          <button id="back-to-main" class="secondary">← Back to Assets</button>
        </header>

        <!-- Settings Tabs -->
        <nav>
          <ul>
            <li><a href="#ldap-settings" class="settings-tab active" data-tab="ldap">LDAP Settings</a></li>
            <li><a href="#poller-settings" class="settings-tab" data-tab="poller">Polling</a></li>
            <li><a href="#system-settings" class="settings-tab" data-tab="system">System</a></li>
          </ul>
        </nav>

        <!-- LDAP Settings Panel -->
        <article id="ldap-settings" class="settings-panel active">
          <h3>LDAP Configuration</h3>
          <form id="ldap-form">
            <input type="text" id="ldap-server" placeholder="LDAP Server (ldap://domain.com:389)" required>
            <input type="text" id="ldap-base-dn" placeholder="Base DN (OU=Users,DC=corp,DC=example,DC=com)" required>
            <input type="text" id="ldap-bind-dn" placeholder="Bind DN (CN=LDAP Reader,OU=Service Accounts,DC=corp,DC=example,DC=com)">
            <input type="password" id="ldap-bind-password" placeholder="Bind Password">
            <input type="text" id="ldap-user-filter" placeholder="User Filter (leave empty for default)">
            <input type="text" id="ldap-user-attr" placeholder="Username Attribute (sAMAccountName)" value="sAMAccountName">
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="submit">Save Settings</button>
              <button type="button" id="test-ldap" class="secondary">Test Connection</button>
              <button type="button" id="import-ldap" class="secondary">Import Users</button>
            </div>

            <div id="ldap-status" class="alert"></div>
          </form>
          
          <details style="margin-top: 20px;">
            <summary><strong>Example LDAP Filters</strong></summary>
            <div style="margin-top: 10px; font-size: 0.9em;">
              <p><strong>Default (if empty):</strong> All users (disabled accounts are filtered out automatically)</p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person))</code>
              
              <p style="margin-top: 15px;"><strong>Users in a specific group:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(memberOf=CN=IT-Staff,OU=Groups,DC=corp,DC=example,DC=com))</code>
              
              <p style="margin-top: 15px;"><strong>Users with email addresses:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(mail=*))</code>
              
              <p style="margin-top: 15px;"><strong>Users in specific department:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(department=IT))</code>
              
              <p style="margin-top: 15px;"><em>Tip: To import from a specific OU, change the Base DN above to point to that OU.</em></p>
              <p style="margin-top: 5px;"><em>Example: OU=IT Department,OU=Users,DC=corp,DC=example,DC=com</em></p>
              
              <p style="margin-top: 15px;"><a href="https://github.com/mcnutter1/ig-asset-system/blob/main/docs/LDAP_FILTERS.md" target="_blank" style="color: #0066cc;">View full filter documentation →</a></p>
            </div>
          </details>
        </article>

        <!-- Polling Settings Panel -->
        <article id="poller-settings" class="settings-panel" style="display: none;">
          <h3>Polling Configuration</h3>
          <form id="poller-form">
            <label>
              Polling Interval (seconds)
              <input type="number" id="poller-interval" min="5" max="3600" value="30" required>
              <small>How often to poll targets (5-3600 seconds)</small>
            </label>

            <label>
              Connection Timeout (seconds)
              <input type="number" id="poller-timeout" min="1" max="60" value="10" required>
              <small>SSH/HTTP connection timeout (1-60 seconds)</small>
            </label>

            <label>
              Ping Timeout (seconds)
              <input type="number" id="poller-ping-timeout" min="1" max="10" value="1" required>
              <small>Network ping timeout (1-10 seconds)</small>
            </label>

            <label>
              API URL
              <input type="url" id="poller-api-url" placeholder="http://localhost:8080/api.php" required>
              <small>API endpoint for poller to send updates</small>
            </label>

            <label>
              API Key
              <input type="text" id="poller-api-key" placeholder="Enter API authentication key" required>
              <small>Authentication key for API access</small>
            </label>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="submit">Save Settings</button>
            </div>

            <div id="poller-config-status" class="alert"></div>

            <h4 style="margin-top: 30px;">Polling Control</h4>
            <div style="display: flex; gap: 10px;">
              <button type="button" id="start-polling-settings" class="success">▶ Start Polling</button>
              <button type="button" id="stop-polling-settings" class="contrast">⏸ Stop Polling</button>
              <span id="polling-status-settings" style="align-self: center; padding: 0 10px;"></span>
            </div>

            <h4 style="margin-top: 30px;">Live Polling Logs</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button type="button" id="start-log-stream" class="success">▶ Start Log Stream</button>
              <button type="button" id="stop-log-stream" class="contrast">⏸ Stop Log Stream</button>
              <button type="button" id="clear-logs">Clear Logs</button>
            </div>
            <div id="poller-logs" style="
              background: #000; 
              color: #0f0; 
              font-family: 'Courier New', monospace; 
              font-size: 12px; 
              padding: 10px; 
              height: 400px; 
              overflow-y: auto; 
              border: 1px solid var(--muted-border-color);
              border-radius: 4px;
            "></div>
          </form>
        </article>

        <!-- System Settings Panel -->
        <article id="system-settings" class="settings-panel" style="display: none;">
          <h3>System Information</h3>
          
          <h4>System Status</h4>
          <div id="system-health-display" style="display: grid; gap: 10px;">
            <!-- Health info will be loaded here -->
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" id="check-health-btn" class="secondary">Check System Health</button>
            <button type="button" id="download-logs-btn" class="secondary">Download Logs</button>
          </div>
        </article>
      </div>
    </section>
  </div>

  <script src="/assets/app.js"></script>
</body>
</html>
