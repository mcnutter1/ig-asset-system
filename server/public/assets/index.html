<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asset Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="/assets/styles.css"/>
</head>
<body>
  <div id="app">
    <!-- Bootstrap Warning -->
    <div id="bootstrap-warning" class="bootstrap-warning hidden">
      <div class="bootstrap-content">
        <h2>⚠️ System Not Initialized</h2>
        <p>The Asset Tracker database has not been set up yet.</p>
        <p>Please run the bootstrap script to initialize the system:</p>
        <pre><code>./bootstrap.sh</code></pre>
        <p>After running bootstrap, refresh this page.</p>
        <button onclick="location.reload()">Refresh Page</button>
      </div>
    </div>

    <!-- Header -->
    <header>
      <nav>
        <ul>
          <li><strong>Asset Tracker</strong></li>
        </ul>
        <ul>
          <li id="user-info"></li>
        </ul>
      </nav>
    </header>

    <!-- Login Panel -->
    <section id="login-panel" class="hidden">
      <article style="max-width: 400px; margin: 50px auto;">
        <h2>Sign in</h2>
        <form>
          <input id="username" placeholder="Username" required>
          <input id="password" type="password" placeholder="Password" required>
          <button id="login-btn">Login</button>
          <div id="login-msg"></div>
        </form>
      </article>
    </section>

    <!-- Main Content -->
    <section id="main" class="hidden">
      <!-- Toolbar -->
      <nav style="background: var(--form-element-background-color);">
        <ul>
          <li>
            <input id="search" placeholder="Search assets..." style="min-width: 300px;">
          </li>
          <li>
            <select id="owner-filter" style="min-width: 200px;">
              <option value="">All Owners</option>
            </select>
          </li>
        </ul>
        <ul>
          <li><button id="refresh">Refresh</button></li>
          <li><button id="new-asset">+ New Asset</button></li>
          <li><button id="column-config">Columns</button></li>
          <li><button id="settings-btn">⚙ Settings</button></li>
        </ul>
      </nav>

      <!-- Asset Table -->
      <div style="overflow-x: auto;">
        <table id="asset-table">
          <thead>
            <tr id="asset-table-head">
              <th>Name</th>
              <th>Type</th>
              <th>IP Addresses</th>
              <th>MAC Address</th>
              <th>Owner</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="asset-list"></tbody>
        </table>
      </div>

      <!-- Asset Detail Drawer -->
      <div id="drawer" class="drawer hidden">
        <div class="drawer-content">
          <button type="button" class="close" aria-label="Close">&times;</button>
          <div id="asset-detail"></div>
        </div>
      </div>

      <!-- Asset Create/Edit Modal -->
      <dialog id="asset-modal">
        <article style="width: 600px;">
          <header>
            <h3 id="modal-title">Add Asset</h3>
            <button type="button" aria-label="Close" class="modal-close"></button>
          </header>
          <form id="asset-form">
            <input type="hidden" id="asset-id">

            <div class="modal-body">
              <div class="grid">
                <label>Name
                  <input type="text" id="asset-name" placeholder="Server-01" required>
                </label>
                <label>Type
                  <input type="text" id="asset-type" placeholder="server" required>
                </label>
              </div>

              <div class="grid">
                <label>Owner
                  <select id="asset-owner">
                    <option value="">No Owner</option>
                  </select>
                </label>
                <label>MAC Address
                  <input type="text" id="asset-mac" placeholder="AA:BB:CC:DD:EE:FF">
                </label>
              </div>

              <label>IP Addresses
                <input type="text" id="asset-ips" placeholder="192.168.1.10, 192.168.1.11">
                <small>Use commas to separate multiple IP addresses.</small>
              </label>

              <label>Attributes (JSON)
                <textarea id="asset-attributes" rows="4" placeholder='{"os": "Ubuntu 22.04"}'></textarea>
                <small>Optional key/value metadata stored as JSON.</small>
              </label>

              <details open>
                <summary>Polling Configuration</summary>
                <label>
                  <input type="checkbox" id="asset-poll-enabled">
                  Enable Polling
                </label>

                <div class="grid">
                  <label>Poll Type
                    <select id="asset-poll-type">
                      <option value="ping">Ping (Online Check Only)</option>
                      <option value="ssh">SSH (Linux/Unix)</option>
                      <option value="wmi">WMI (Windows)</option>
                      <option value="snmp">SNMP</option>
                    </select>
                  </label>
                  <label>Poll Port (optional)
                    <input type="number" id="asset-poll-port" placeholder="22 for SSH, 5985 for WMI">
                  </label>
                </div>

                <div class="grid">
                  <label>Poll Username
                    <input type="text" id="asset-poll-username" placeholder="admin">
                  </label>
                  <label>Poll Password
                    <input type="password" id="asset-poll-password" placeholder="Password">
                  </label>
                </div>
              </details>

              <div id="custom-fields-container"></div>
            </div>

            <footer class="modal-footer">
              <button type="button" class="secondary modal-cancel">Cancel</button>
              <button type="submit">Save Asset</button>
            </footer>
          </form>
        </article>
      </dialog>

      <!-- Delete Modal -->
      <dialog id="delete-modal">
        <article>
          <header>
            <h3>Delete Asset</h3>
            <button type="button" aria-label="Close" class="modal-close"></button>
          </header>
          <p>Are you sure you want to delete this asset?</p>
          <p><strong id="delete-asset-name"></strong></p>
          <p>This action cannot be undone.</p>
          <div style="display: flex; gap: 10px;">
            <button id="confirm-delete" class="contrast">Delete</button>
            <button type="button" class="secondary modal-cancel">Cancel</button>
          </div>
        </article>
      </dialog>

      <!-- Column Preferences Modal -->
      <dialog id="column-modal">
        <article>
          <header>
            <h3>Customize Columns</h3>
            <button type="button" aria-label="Close" class="modal-close"></button>
          </header>
          <form id="column-form">
            <div class="modal-body">
              <fieldset>
                <legend>Select the columns you want to see</legend>
                <div id="column-options" class="column-options-grid"></div>
              </fieldset>
              <p id="column-error" class="form-error hidden"></p>
            </div>
            <footer class="modal-footer">
              <button type="button" id="reset-columns" class="secondary">Reset to Default</button>
              <span class="flex-spacer"></span>
              <button type="button" class="secondary modal-cancel">Cancel</button>
              <button type="submit">Save</button>
            </footer>
          </form>
        </article>
      </dialog>

      <!-- Polling Status -->
      <footer style="margin-top: 20px;">
        <span id="polling-status" style="color: var(--muted-color);">Polling: Unknown</span>
      </footer>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="hidden">
      <div style="max-width: 900px; margin: 20px auto;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
          <h2>System Settings</h2>
          <button id="back-to-main" class="secondary">← Back to Assets</button>
        </header>

        <!-- Settings Tabs -->
        <nav>
          <ul>
            <li><a href="#ldap-settings" class="settings-tab active" data-tab="ldap">LDAP Settings</a></li>
            <li><a href="#poller-settings" class="settings-tab" data-tab="poller">Polling</a></li>
            <li><a href="#custom-fields-settings" class="settings-tab" data-tab="custom-fields">Custom Fields</a></li>
            <li><a href="#system-settings" class="settings-tab" data-tab="system">System</a></li>
          </ul>
        </nav>

        <!-- LDAP Settings Panel -->
        <article id="ldap-settings" class="settings-panel active">
          <h3>LDAP Configuration</h3>
          <form id="ldap-form">
            <input type="text" id="ldap-server" placeholder="LDAP Server (ldap://domain.com:389)" required>
            <input type="text" id="ldap-base-dn" placeholder="Base DN (OU=Users,DC=corp,DC=example,DC=com)" required>
            <input type="text" id="ldap-bind-dn" placeholder="Bind DN (CN=LDAP Reader,OU=Service Accounts,DC=corp,DC=example,DC=com)">
            <input type="password" id="ldap-bind-password" placeholder="Bind Password">
            <input type="text" id="ldap-user-filter" placeholder="User Filter (leave empty for default)">
            <input type="text" id="ldap-user-attr" placeholder="Username Attribute (sAMAccountName)" value="sAMAccountName">
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="submit">Save Settings</button>
              <button type="button" id="test-ldap" class="secondary">Test Connection</button>
              <button type="button" id="import-ldap" class="secondary">Import Users</button>
            </div>

            <div id="ldap-status" class="alert"></div>
          </form>
          
          <details style="margin-top: 20px;">
            <summary><strong>Example LDAP Filters</strong></summary>
            <div style="margin-top: 10px; font-size: 0.9em;">
              <p><strong>Default (if empty):</strong> All users (disabled accounts are filtered out automatically)</p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person))</code>
              
              <p style="margin-top: 15px;"><strong>Users in a specific group:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(memberOf=CN=IT-Staff,OU=Groups,DC=corp,DC=example,DC=com))</code>
              
              <p style="margin-top: 15px;"><strong>Users with email addresses:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(mail=*))</code>
              
              <p style="margin-top: 15px;"><strong>Users in specific department:</strong></p>
              <code style="display: block; background: #f5f5f5; padding: 8px; margin: 5px 0; border-radius: 4px;">(&(objectClass=user)(objectCategory=person)(department=IT))</code>
              
              <p style="margin-top: 15px;"><em>Tip: To import from a specific OU, change the Base DN above to point to that OU.</em></p>
              <p style="margin-top: 5px;"><em>Example: OU=IT Department,OU=Users,DC=corp,DC=example,DC=com</em></p>
              
              <p style="margin-top: 15px;"><a href="https://github.com/mcnutter1/ig-asset-system/blob/main/docs/LDAP_FILTERS.md" target="_blank" style="color: #0066cc;">View full filter documentation →</a></p>
            </div>
          </details>
        </article>

        <!-- Polling Settings Panel -->
        <article id="poller-settings" class="settings-panel" style="display: none;">
          <h3>Polling Configuration</h3>
          <form id="poller-form">
            <label>
              Polling Interval (seconds)
              <input type="number" id="poller-interval" min="5" max="3600" value="30" required>
              <small>How often to poll targets (5-3600 seconds)</small>
            </label>

            <label>
              Connection Timeout (seconds)
              <input type="number" id="poller-timeout" min="1" max="60" value="10" required>
              <small>SSH/HTTP connection timeout (1-60 seconds)</small>
            </label>

            <label>
              Ping Timeout (seconds)
              <input type="number" id="poller-ping-timeout" min="1" max="10" value="1" required>
              <small>Network ping timeout (1-10 seconds)</small>
            </label>

            <label>
              API URL
              <input type="url" id="poller-api-url" placeholder="http://localhost:8080/api.php" required>
              <small>API endpoint for poller to send updates</small>
            </label>

            <label>
              API Key
              <input type="text" id="poller-api-key" placeholder="Enter API authentication key" required>
              <small>Authentication key for API access</small>
            </label>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="submit">Save Settings</button>
            </div>

            <div id="poller-config-status" class="alert"></div>

            <h4 style="margin-top: 30px;">Polling Control</h4>
            <div style="display: flex; gap: 10px;">
              <button type="button" id="start-polling-settings" class="success">▶ Start Polling</button>
              <button type="button" id="stop-polling-settings" class="contrast">⏸ Stop Polling</button>
              <span id="polling-status-settings" style="align-self: center; padding: 0 10px;"></span>
            </div>

            <h4 style="margin-top: 30px;">Live Polling Logs</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button type="button" id="start-log-stream" class="success">▶ Start Log Stream</button>
              <button type="button" id="stop-log-stream" class="contrast">⏸ Stop Log Stream</button>
              <button type="button" id="clear-logs">Clear Logs</button>
            </div>
            <div id="poller-logs" style="
              background: #000; 
              color: #0f0; 
              font-family: 'Courier New', monospace; 
              font-size: 12px; 
              padding: 10px; 
              height: 400px; 
              overflow-y: auto; 
              border: 1px solid var(--muted-border-color);
              border-radius: 4px;
            "></div>
          </form>
        </article>

        <!-- Custom Fields Settings Panel -->
        <article id="custom-fields-settings" class="settings-panel" style="display: none;">
          <h3>Custom Fields Management</h3>
          <p style="color: var(--muted-color); margin-bottom: 20px;">
            Create custom fields that will appear when viewing or editing assets. Fields can be applied to all asset types or specific types only.
          </p>

          <button id="add-custom-field-btn" style="margin-bottom: 20px;">+ Add Custom Field</button>

          <div id="custom-fields-list" style="display: grid; gap: 15px;">
            <!-- Custom fields will be loaded here -->
          </div>
        </article>

        <!-- System Settings Panel -->
        <article id="system-settings" class="settings-panel" style="display: none;">
          <h3>System Information</h3>
          
          <h4>System Status</h4>
          <div id="system-health-display" style="display: grid; gap: 10px;">
            <!-- Health info will be loaded here -->
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" id="check-health-btn" class="secondary">Check System Health</button>
            <button type="button" id="download-logs-btn" class="secondary">Download Logs</button>
          </div>
        </article>
      </div>
    </section>

    <!-- Custom Field Edit Modal -->
    <dialog id="custom-field-modal">
      <article style="width: 600px;">
        <header>
          <h3 id="field-modal-title">Add Custom Field</h3>
            <button type="button" aria-label="Close" class="modal-close"></button>
        </header>
        <form id="custom-field-form">
          <input type="hidden" id="field-id">
          
          <label>Field Name (identifier, snake_case)
            <input type="text" id="field-name" placeholder="serial_number" required pattern="[a-z_]+" title="Lowercase letters and underscores only">
          </label>

          <label>Display Label
            <input type="text" id="field-label" placeholder="Serial Number" required>
          </label>

          <label>Field Type
            <select id="field-type" required>
              <option value="text">Text</option>
              <option value="textarea">Text Area</option>
              <option value="number">Number</option>
              <option value="date">Date</option>
              <option value="select">Dropdown Select</option>
              <option value="checkbox">Checkbox</option>
              <option value="email">Email</option>
              <option value="url">URL</option>
            </select>
          </label>

          <div id="select-options-container" style="display: none;">
            <label>Dropdown Options (one per line)
              <textarea id="field-select-options" rows="4" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
              <small>Enter each option on a new line</small>
            </label>
          </div>

          <label>Default Value
            <input type="text" id="field-default-value" placeholder="Optional default value">
          </label>

          <label>Help Text
            <input type="text" id="field-help-text" placeholder="Help text shown to users">
          </label>

          <label>
            <input type="checkbox" id="field-required">
            Required Field
          </label>

          <label>Apply to Asset Types (leave empty for all types)
            <input type="text" id="field-applies-to" placeholder="server, workstation, network-device (comma-separated)">
            <small>Leave empty to apply to all asset types, or specify comma-separated types</small>
          </label>

          <label>Display Order
            <input type="number" id="field-display-order" value="0" min="0" step="10">
            <small>Controls the order fields appear (lower numbers first)</small>
          </label>

          <footer style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="secondary" onclick="document.getElementById('custom-field-modal').close()">Cancel</button>
            <button type="submit">Save Field</button>
          </footer>
        </form>
      </article>
    </dialog>
  </div>

  <script src="/assets/app.js"></script>
</body>
</html>
